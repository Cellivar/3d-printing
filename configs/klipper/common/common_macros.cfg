## Common macros that don't fit into other categories
# Example config
# [gcode_macro _EXTENDED_GCODE_COMMANDS]
#   description: Configuration for custom gcode command overrides, for additional features.
#
#   # Configure the mapping of fan_generic to P parameters for M106
#   # This lets your slicer emit 'M106 P3 S255' style commands for chamber cooling
#   # Make sure the list includes up to the index you intend to use!
#   variable_fan_list = [
#     '', # P0, leave blank for default [fan].
#     '', # P1
#     '', # P2, "AUX_FAN" on bambu
#     'FILTER_FANS'] # P3, chamber filter, generated by OrcaSlicer.

[gcode_macro M106] # Set Fan Speed
  rename_existing: M106.106
  description: Override M106 to support P fan parameter
  gcode:
    {% set p = params.P | default(0) | int %}
    {% set s = params.S | default(255) | float %}
    {% set fans = printer['gcode_macro _EXTENDED_GCODE_COMMANDS'].fan_list | default([]) %}

    {% if (p > fans | length) %}
      { action_raise_error('Invalid fan index %s, did you set fan_list correctly?' % p) }
    {% endif %}

    {% if p == 0 and (fans[0] == None or fans[0] == '') %}
      M106.106 S{s}
    {% else %}
      {% if s > 1.0 %}
        {% set s = (s % 256) / 255 %}
      {% endif %}
      SET_FAN_SPEED FAN={fans[p]} SPEED={s}
    {% endif %}

[gcode_macro M107] # Fan Off
  rename_existing: M107.107
  description: Override M107 to support P fan parameter
  gcode:
    {% set p = params.P | default(0) | int %}
    {% set fans = printer['gcode_macro _EXTENDED_GCODE_COMMANDS'].fan_list | default([]) %}

    {% if (p > fans | length) %}
      { action_raise_error('Invalid fan index %s, did you set fan_list correctly?' % p) }
    {% endif %}

    {% if p == 0 and (fans[0] == None or fans[0] == '') %}
      M107.107
    {% else %}
      SET_FAN_SPEED FAN={fans[p]} SPEED=0.0
    {% endif %}

[gcode_macro M109] # Set Extruder Temperature and Wait
  description: Override M109 to use TEMPERATURE_WAIT instead.
  rename_existing: M109.109
  gcode:
    # https://github.com/Klipper3d/klipper/blob/master/klippy/kinematics/extruder.py#L252
    {% set s = params.S | float %}
    {% set t = params.T | default(0) | int %}

    # Set hotend temp
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

    {% if t == 0 %}
      {% set sensor = "extruder"%}
    {% else %}
      {% set sensor = "extruder%s" % (t) %}
    {% endif %}

    {% if s != 0 %}
      # Wait for hotend temp (within 1 degree)
      M117 Heat {sensor}
      TEMPERATURE_WAIT SENSOR={sensor} MINIMUM={s} MAXIMUM={s+1}
    {% endif %}

[gcode_macro M117]
rename_existing: M117.1
gcode:
  {% if rawparams %}
    {% set escaped_msg = rawparams.split(';', 1)[0].split('\x23', 1)[0]|replace('"', '\\"') %}
    SET_DISPLAY_TEXT MSG="{escaped_msg}"
    RESPOND TYPE=command MSG="{escaped_msg}"
  {% else %}
    SET_DISPLAY_TEXT
  {% endif %}

[gcode_macro M190] # Set Bed Temperature and Wait
  rename_existing: M190.190
  gcode:
    # https://github.com/Klipper3d/klipper/blob/master/klippy/extras/heater_bed.py
    {% set s = params.S | float %}

    # Set hotend temp
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

    {% if s != 0 %}
      # Wait for bed temp (within 1 degree)
      M117 Heat {sensor}
      TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s} MAXIMUM={s+1}
    {% endif %}

# Enable stepper idle currents when printer is idle.
[gcode_macro _ENABLE_STEPPER_CHILLAX]
  description = Reduce hold current for steppers when idle, to keep them cooler
  variable_driver = "tmc2209"
  variable_idle_current_ratio = 0.2
  gcode =
    {% for stepper in printer.motion_report.steppers %}
      {% if stepper.startswith("stepper_") %}
        {% set holdcurrent = idle_current_ratio * printer["%s %s" % (driver, stepper)].run_current %}
        SET_TMC_CURRENT STEPPER={stepper} HOLDCURRENT={holdcurrent}
      {% endif %}
    {% endfor %}

[gcode_macro _DISABLE_STEPPER_CHILLAX]
  description = Disable hold current for steppers when idle, for stability
  variable_driver = "tmc2209"
  gcode =
    {% for stepper in printer.motion_report.steppers %}
      {% if stepper.startswith("stepper_") %}
        {% set runcurrent = printer["%s %s" % (driver, stepper)].run_current %}
        SET_TMC_CURRENT STEPPER={stepper} HOLDCURRENT={runcurrent}
      {% endif %}
    {% endfor %}

[delayed_gcode _stepper_chillax_init]
  initial_duration = 0.1
  gcode =
    _ENABLE_STEPPER_CHILLAX

[gcode_macro _GENTLE_MOVE_Z]
  description: Gently move the bed relatively, usually when homing
  gcode:
    # We aren't sure where we are, so move GENTLY
    {% set HOME_CURRENT = 0.15 %}
    {% set distance = params.DISTANCE | default(0.0) | float %}

    # Assume there's at least one config, and all the configs are the same..
    {% set RUN_CURRENT_Z = printer.configfile.settings['tmc2209 stepper_z'].run_current | float %}

    SAVE_GCODE_STATE NAME=GENTLE_MOVE_Z

    {% for stepper in printer.motion_report.steppers %}
      {% if stepper.startswith("stepper_z") %}
        SET_TMC_CURRENT STEPPER={stepper} CURRENT={HOME_CURRENT}
      {% endif %}
    {% endfor %}

    G91
    G1 Z{distance}

    {% for stepper in printer.motion_report.steppers %}
      {% if stepper.startswith("stepper_z") %}
        SET_TMC_CURRENT STEPPER={stepper} CURRENT={RUN_CURRENT_Z}
      {% endif %}
    {% endfor %}

    RESTORE_GCODE_STATE NAME=GENTLE_MOVE_Z

# One button macro to get the printer warmed up and ready to print
[gcode_macro INITIALIZE]
  description: Start up printer and go through the motions, literally.
  gcode:
    _START_CALIBRATE

    # Start heat soaking the bed.
    M140 S60
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z50 F8000
    M117 ...Idle...
